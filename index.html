<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kicks - Boutique</title>

<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<script src="https://www.google.com/recaptcha/api.js?hl=fr" async defer></script>
<script src="https://www.paypal.com/sdk/js?client-id=AXd7iZon2xRzhIauBjGdjwxQk237evP3BTtNfqIKpEaYDTOk9S733o-_GcPQIqhZ7bCalMG-M_PNaRHG&currency=EUR" data-sdk-integration-source="button-factory"></script>
<script type="text/javascript" src="https://gateway.sumup.com/gateway/ecom/card/v2/sdk.js"></script>

<style>
  :root{
    --orange:#FFA133;
    --anthracite:#1a1a1a;
    --white:#ffffff;
    --paypal:#003087;
    --whatsapp: #25D366;
    --bg:#f8f8f8;
  }
  html,body{ height:100%; margin:0; padding:0; background:var(--bg); font-family:Inter,system-ui,Arial,Helvetica,sans-serif; color:#111; -webkit-font-smoothing:antialiased; }
  .text-orange{ color:var(--orange); }
  .bg-orange{ background-color:var(--orange); }
  .hover-bg-orange:hover{ background-color:var(--orange); }
  .focus-ring-orange:focus{ --tw-ring-color: var(--orange); }
  .border-orange{ border-color:var(--orange); }
  .text-anthracite{ color:var(--anthracite); }
  .border-anthracite{ border-color:var(--anthracite); }
  .hover-bg-anthracite:hover{ background-color:var(--anthracite); }
  .text-whatsapp{ color:var(--whatsapp); }
  .text-paypal{ color:var(--paypal); }
  .text-xs-force{ font-size: 0.7rem !important; }

  /* Pour cacher la colonne de droite sur mobile par défaut */
  @media (max-width: 1023px) {
    #form-paiement-modal { display: none; }
  }

  /* Pour afficher la modal d'image en plein écran */
  #img-modal {
    position: fixed; top: 0; left: 0; z-index: 50;
    width: 100%; height: 100%;
    background-color: rgba(0, 0, 0, 0.9);
    display: none; /* Cacher par défaut */
    align-items: center; justify-content: center;
  }
  #img-modal img { max-height: 90vh; max-width: 90vw; object-fit: contain; }
  /* CORRECTION: ID ajouté au bouton fermer */
  .modal-close-btn { position: absolute; top: 20px; right: 40px; color: white; font-size: 2rem; cursor: pointer; }
</style>

</head>
<body>
<div id="app" class="min-h-screen bg-gray-50 flex flex-col">
  <header class="bg-white shadow-md sticky top-0 z-10">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center">
      <h1 class="text-2xl font-extrabold text-orange">KICKS BOUTIQUE</h1>
      <div class="flex items-center space-x-4">
        <button id="cart-button" onclick="document.getElementById('form-paiement-modal').style.display = 'block'; updateCartDisplays();" class="relative p-2 bg-orange text-white rounded-full hover:bg-anthracite transition duration-200 lg:hidden">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
          </svg>
          <span id="cart-count" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full">0</span>
        </button>
      </div>
    </div>
  </header>

  <main class="flex-grow max-w-7xl mx-auto w-full lg:flex lg:space-x-8 p-4 sm:p-6 lg:p-8">
    
    <div class="lg:w-2/3">
        <section class="mb-8">
            <h2 class="text-3xl font-bold text-anthracite mb-6">Nos Produits</h2>
            <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6">
                </div>
            <p id="loading-message" class="text-center mt-8 text-gray-500">Chargement des produits...</p>
        </section>

        <section id="panier-mobile" class="lg:hidden p-4 mt-8 bg-white shadow-lg rounded-lg border border-gray-200">
            <h2 class="text-xl font-bold text-anthracite mb-4">Votre Panier</h2>
            <div id="cart-items-list-mobile" class="space-y-4">
                 <p id="empty-cart-message-mobile" class="text-gray-500 italic">Votre panier est vide.</p>
            </div>
            <div class="mt-4 pt-4 border-t border-gray-200 space-y-2">
                <div class="flex justify-between items-center text-sm">
                    <span>Sous-total:</span>
                    <span id="cart-subtotal-mobile">0.00 €</span>
                </div>
                <div class="flex justify-between items-center text-sm border-b pb-2 mb-2">
                    <span>Frais de port:</span>
                    <span id="cart-shipping-mobile">0.00 €</span>
                </div>
                <div class="flex justify-between font-bold text-lg pt-2">
                    <span>Total (TTC):</span>
                    <span id="cart-total-mobile">0.00 €</span>
                </div>
            </div>
            <button onclick="document.getElementById('form-paiement-modal').style.display = 'block'; updateCartDisplays();" class="mt-4 w-full bg-orange text-white py-3 rounded-md font-semibold hover:bg-anthracite transition duration-200">
                Finaliser la Commande
            </button>
            <button id="btn-clear-cart-default" class="mt-2 w-full text-red-500 text-sm hover:text-red-700">Vider le panier</button>
        </section>

    </div>
	<aside id="form-paiement-modal" class="lg:w-1/3 lg:sticky lg:top-20 h-full bg-white shadow-2xl rounded-lg p-6 border-l border-gray-100 absolute lg:relative top-0 left-0 w-full z-20">
      <button id="close-checkout-button" onclick="document.getElementById('form-paiement-modal').style.display='none';" class="modal-close-btn text-anthracite hover:text-orange lg:hidden">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
      </button>

      <h2 class="text-2xl font-bold text-anthracite mb-6 border-b pb-3">Récapitulatif & Paiement</h2>
      
      <div id="cart-items-list" class="space-y-3 max-h-48 overflow-y-auto mb-4">
          <p id="empty-cart-message" class="text-gray-500 italic">Votre panier est vide.</p>
      </div>
      
      <div class="border-t pt-4 space-y-2">
          <div class="flex justify-between items-center text-sm">
              <span>Sous-total:</span>
              <span id="cart-subtotal">0.00 €</span>
          </div>
          <div class="flex justify-between items-center text-sm border-b pb-2 mb-2">
              <span>Frais de port:</span>
              <span id="cart-shipping">0.00 €</span>
          </div>
          <div class="flex justify-between font-bold text-lg pt-2">
              <span>Total final (TTC):</span>
              <span id="cart-total" class="text-orange">0.00 €</span>
          </div>
      </div>
      
      <button id="btn-clear-cart" class="w-full mt-4 text-red-500 text-sm hover:text-red-700">Vider le panier</button>

      <form id="checkout-form" class="mt-6 space-y-4">
        <h3 class="text-xl font-semibold mb-4 border-b pb-2">Informations Client</h3>
        <div class="grid grid-cols-2 gap-4">
            <input type="text" id="prenom" placeholder="Prénom" required class="p-3 border rounded-md w-full">
            <input type="text" id="nom" placeholder="Nom" required class="p-3 border rounded-md w-full">
        </div>
        <input type="email" id="email" placeholder="Email" required class="p-3 border rounded-md w-full">
        <input type="tel" id="telephone" placeholder="Téléphone (ex: 0690xxxxxx)" required class="p-3 border rounded-md w-full">

        <div id="shipping-options-container" class="my-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
            <h2>Options de Livraison</h2>
            <p class="text-gray-500 text-sm mt-1">Chargement des tarifs...</p>
        </div>
        <input type="text" id="adresse" placeholder="Adresse complète" required class="p-3 border rounded-md w-full">
        <input type="text" id="commune-cp" placeholder="Ville et Code Postal" required class="p-3 border rounded-md w-full">
        
        <input type="hidden" id="total-final-client-input" value="0.00">
        <input type="hidden" id="nombre-articles-total" value="0">
        <input type="hidden" id="payment-method" value="virement">
        
        <h3 class="text-xl font-semibold mb-4 border-b pb-2 pt-4">Paiement</h3>
        <div class="space-y-4">
            <p class="text-xl font-bold text-center p-3 rounded-md bg-orange text-white">
                Total à payer : <span id="form-total-text">0.00 €</span>
            </p>

            <button type="button" id="sumup-btn" class="w-full py-3 bg-blue-600 text-white rounded-md font-semibold hover:bg-blue-700 transition duration-200 flex items-center justify-center space-x-2" style="background-color: #003087;">
                Payer par Carte
            </button>

            <div id="paypal-button-container" data-rendered="false" class="flex justify-center mt-2"></div>

            <button type="button" id="virement-button" class="w-full py-3 bg-anthracite text-white rounded-md font-semibold hover:opacity-90 transition duration-200">
                Payer par Virement
            </button>
            <div id="virement-info" class="hidden p-4 bg-gray-100 rounded-md text-sm border border-gray-300">
                <p class="font-bold mb-2">Détails du Virement Bancaire</p>
                <p><strong>Banque:</strong> SumUp Limited</p>
                <p><strong>IBAN:</strong> IE85SUMU99010078239088</p>
                <p><strong>Bénéficiaire:</strong> E.I.RL Kicks</p>
                <p class="mt-3 text-red-500">Votre commande sera traitée après réception du paiement. Veuillez indiquer votre nom en référence.</p>
            </div>
        </div>

        <div class="flex justify-center pt-4">
            <div class="g-recaptcha" data-sitekey="6LcBZwosAAAAAG8xMR5po1FuipWeEo-_mJlROYFN"></div>
        </div>

        <button type="button" id="btn-submit-quick" class="w-full py-3 bg-orange text-white rounded-md font-semibold hover:bg-anthracite transition duration-200 mt-4">
            Confirmer la Commande (Virement)
        </button>
      </form>
    </aside>
  </main>

  <section class="bg-anthracite text-white py-12">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
        <h2 class="text-3xl font-bold mb-4">Abonnez-vous à notre Newsletter</h2>
        <p class="mb-6">Recevez les dernières nouveautés et offres spéciales directement dans votre boîte mail.</p>
        <form id="newsletter-form" class="max-w-md mx-auto flex space-x-2">
            <input type="email" id="newsletter-email" placeholder="Votre adresse e-mail" required class="p-3 flex-grow rounded-l-md text-gray-800">
            <button type="submit" class="p-3 bg-orange rounded-r-md font-semibold hover:bg-white hover:text-orange transition duration-200">S'abonner</button>
        </form>
        <p id="newsletter-message" class="mt-4 text-green-400 hidden"></p>
    </div>
  </section>

  <footer class="bg-anthracite text-gray-400 py-6 border-t border-gray-700">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-sm">
        <p>© 2025 Kicks Boutique. Tous droits réservés.</p>
    </div>
  </footer>
</div>

<div id="img-modal">
  <span id="close-img-modal-btn" class="modal-close-btn">&times;</span>
  <img id="modal-image" src="" alt="Aperçu du produit">
  <button id="prev-img-btn" class="absolute left-10 p-4 text-white bg-black bg-opacity-50 rounded-full text-2xl z-50">&#10094;</button>
  <button id="next-img-btn" class="absolute right-10 p-4 text-white bg-black bg-opacity-50 rounded-full text-2xl z-50">&#10095;</button>
</div>
<script>
/* ==================================================================
 * MODIFICATIONS JAVASCRIPT CORRIGÉES
 * ================================================================== */
// Variables et Cartographie
const API_URL = 'https://script.google.com/macros/s/AKfycbxPWgXGaR1YUbznCT4fEr1coqDtmtyMVUdlKGlEEpBXo7JhDsJpiFbrFZkfPcl1of9U_w/exec'; // URL Apps Script
let cart = [];
let products = [];
let shippingRates = []; // Stocke les tarifs de livraison
let selectedShipping = null; // Le tarif de livraison sélectionné
let currentModal = { product: null, imgIndex: 0 };
// Référence du conteneur de produits
const productContainer = document.getElementById('product-list');

// --- FONCTIONS DE BASE ---

// Fonction POST générique
async function postData(payload) {
    // CORRECTION: payload envoyé en JSON brut, comme attendu par le Apps Script
    const response = await fetch(API_URL, {
        method: 'POST',
        mode: 'cors',
        cache: 'no-cache',
        headers: {
            'Content-Type': 'application/json', // Changé pour correspondre à JSON.parse(e.postData.contents)
        },
        body: JSON.stringify(payload) // Envoyer en JSON
    });
    return response.json();
}

// Fonction pour récupérer les produits (getProduits)
async function fetchProducts() {
    try {
        const response = await fetch(`${API_URL}?action=getProduits`);
        const data = await response.json();
        document.getElementById('loading-message').style.display = 'none';
        
        // CORRECTION ICI: Remplacer data.products par data.produits
        if(data.success && data.produits) { 
            products = data.produits; // CORRECTION ICI
            renderProducts(products);
        } else {
            console.error('Erreur lors de la récupération des produits:', data.error); 
            productContainer.innerHTML = '<p class="text-red-500 text-center col-span-full">Erreur: Impossible de charger les produits. Veuillez réessayer.</p>';
        }
    } catch(error) {
        console.error('Erreur réseau fetchProducts:', error);
        productContainer.innerHTML = '<p class="text-red-500 text-center col-span-full">Erreur réseau: Impossible de communiquer avec le serveur.</p>';
    }
}

// NOUVELLE FONCTION: Récupérer les tarifs de livraison
async function fetchShippingRates() {
    try {
        const response = await fetch(`${API_URL}?action=getShippingRates`);
        const data = await response.json();
        if(data.success) {
            shippingRates = data.rates;
            updateShippingOptions(shippingRates); // Appelle la nouvelle fonction de mise à jour HTML
        } else {
            console.error('Erreur lors de la récupération des tarifs de livraison:', data.error);
            document.getElementById('shipping-options-container').innerHTML = `<p class="text-red-500 text-sm mt-1">Erreur: Impossible de charger les tarifs de livraison. ${data.error}</p>`;
        }
    } catch(error) {
        console.error('Erreur réseau fetchShippingRates:', error);
        document.getElementById('shipping-options-container').innerHTML = `<p class="text-red-500 text-sm mt-1">Erreur réseau: Impossible de communiquer avec le serveur pour les tarifs.</p>`;
    }
}

// NOUVELLE FONCTION: Mettre à jour les options de livraison dans le formulaire
function updateShippingOptions(rates) {
    const container = document.getElementById('shipping-options-container');
    if (!container) return; 

    // 1. Grouper par Zone (pour les menus déroulants)
    const zones = {};
    rates.forEach(rate => {
        if (!zones[rate.zone]) { zones[rate.zone] = {}; }
        if (!zones[rate.zone][rate.mode]) { zones[rate.zone][rate.mode] = []; }
        zones[rate.zone][rate.mode].push(rate);
    });

    let html = `
        <div class="space-y-4">
            <div>
                <label for="shipping-zone" class="block text-sm font-medium text-gray-700">Zone de Livraison</label>
                <select id="shipping-zone" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-orange focus:border-orange sm:text-sm rounded-md bg-white" required>
                    <option value="" disabled selected>Sélectionnez votre zone...</option>
                    ${Object.keys(zones).map(zone => `<option value="${zone}">${zone.replace(/_/g, ' ')}</option>`).join('')}
                </select>
            </div>
            <div id="mode-livraison-div" class="hidden">
                <label for="shipping-mode" class="block text-sm font-medium text-gray-700">Mode de Livraison</label>
                <select id="shipping-mode" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-orange focus:border-orange sm:text-sm rounded-md bg-white" required>
                    <option value="" disabled selected>Sélectionnez le mode...</option>
                </select>
                <p id="shipping-details" class="mt-2 text-xs text-gray-500"></p>
            </div>
        </div>
    `;
    container.innerHTML = html;
    
    // 2. Écouteurs d'événements pour la sélection
    document.getElementById('shipping-zone').addEventListener('change', (e) => {
        const selectedZone = e.target.value;
        const modeSelect = document.getElementById('shipping-mode');
        const modeDiv = document.getElementById('mode-livraison-div');
        modeSelect.innerHTML = '<option value="" disabled selected>Sélectionnez le mode...</option>';
        selectedShipping = null; // Réinitialiser
        modeDiv.classList.add('hidden');
        document.getElementById('shipping-details').textContent = '';
        updateCartDisplays(); // Réinitialiser le total

        if (selectedZone && zones[selectedZone]) {
            modeDiv.classList.remove('hidden');
            Object.keys(zones[selectedZone]).forEach(mode => {
                modeSelect.innerHTML += `<option value="${mode}">${mode.replace(/_/g, ' ')}</option>`;
            });
        }
    });

    document.getElementById('shipping-mode').addEventListener('change', (e) => {
        const selectedZone = document.getElementById('shipping-zone').value;
        const selectedMode = e.target.value;
        
        const subtotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
        
        // CORRECTION: Trouver le bon tarif basé sur le sous-total
        const applicableRates = zones[selectedZone][selectedMode] || [];
        const rate = applicableRates.find(r => subtotal >= r.min && subtotal <= r.max);

        if (rate) {
            selectedShipping = rate;
            document.getElementById('shipping-details').textContent = `Tarif trouvé pour un sous-total de ${subtotal.toFixed(2)}€ : ${rate.cost.toFixed(2)} €`;
        } else {
            selectedShipping = null;
            // CORRECTION: Utilise le sous-total actuel pour le message d'erreur
            const rateNotFound = applicableRates.length > 0 ? 
                ` (Tranche non trouvée pour ${subtotal.toFixed(2)}€)` : 
                ' (Mode invalide)';
            document.getElementById('shipping-details').textContent = 'Attention: Aucun tarif précis trouvé.' + rateNotFound;
        }
        updateCartDisplays();
    });
}


// Fonction pour l'ajout au panier
function addToCart(id) {
    const product = products.find(p => p.id === id);
    if (!product) return alert('Produit non trouvé.');
    if (product.stock <= 0) return alert('Ce produit est actuellement en rupture de stock.');

    const cartItem = cart.find(item => item.id === id);
    if (cartItem) {
        if (cartItem.quantity < product.stock) {
            cartItem.quantity++;
        } else {
            return alert(`Stock maximum atteint pour ${product.masterName} (Taille ${product.size}).`);
        }
    } else {
        cart.push({
            id: product.id,
            name: product.masterName,
            size: product.size,
            price: product.price,
            quantity: 1,
            stock: product.stock, // Stocke le stock max
            imageUrls: product.imageUrls // Stocke l'image pour le panier
        });
    }
    updateCartDisplays();
    alert(`Ajouté au panier: ${product.masterName} (Taille ${product.size})`);
}

// Fonctions pour changer la quantité et retirer
function changeQuantity(id, change) {
    const cartItem = cart.find(item => item.id === id);
    if (!cartItem) return;

    const newQuantity = cartItem.quantity + parseInt(change, 10);

    if (newQuantity <= 0) {
        removeItem(id);
        return;
    }
    
    if (newQuantity > cartItem.stock) {
         cartItem.quantity = cartItem.stock;
         return alert(`Stock maximum atteint pour ${cartItem.name} (Taille ${cartItem.size}).`);
    }
    
    cartItem.quantity = newQuantity;
    updateCartDisplays();
}

function removeItem(id) {
    cart = cart.filter(item => item.id !== id);
    updateCartDisplays();
}

// Fonction de rendu des produits (CORRIGÉE: Échappement des caractères)
function renderProducts(products) {
    let html = '';
    const uniqueProducts = {}; // Pour grouper par masterName

    // Regrouper les produits par masterName
    products.forEach(p => {
        if (!uniqueProducts[p.masterName]) {
            uniqueProducts[p.masterName] = {
                ...p,
                variants: []
            };
        }
        uniqueProducts[p.masterName].variants.push(p);
    });

    // Itérer sur les produits uniques
    for (const masterName in uniqueProducts) {
        const p = uniqueProducts[masterName];
        const imageUrl = p.imageUrls && p.imageUrls[0] ? p.imageUrls[0] : 'placeholder.png';
        
        // CORRECTION: Échappement des chaînes pour l'injection HTML
        const safeMasterName = (p.masterName || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'");
        const safeDescription = (p.seoDescription || 'Description non disponible.').replace(/\\/g, '\\\\').replace(/'/g, "\\'");

        // Générer les boutons de taille
        let sizeButtons = p.variants
            .sort((a, b) => parseFloat(a.size) - parseFloat(b.size)) // Trier par taille
            .map(variant => {
                const stockText = variant.stock > 0 ? `(Stock: ${variant.stock})` : '(Rupture)';
                const disabled = variant.stock <= 0 ? 'disabled' : '';
                const safeVariantName = (variant.masterName || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'");
                const safeVariantSize = (variant.size || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'");
                
                return `<button onclick="addToCart('${variant.id}')" 
                                class="bg-gray-100 text-anthracite hover:bg-orange hover:text-white transition duration-200 text-sm font-medium py-1 px-3 rounded-full ${disabled ? 'opacity-50 cursor-not-allowed' : ''}" 
                                ${disabled}
                                title="${safeVariantName} T.${safeVariantSize} ${stockText}">
                            T. ${safeVariantSize}
                        </button>`;
            }).join('');

        html += `
            <div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition duration-300 overflow-hidden">
                <div class="relative cursor-pointer" onclick="openImageModal('${p.id}', 0)">
                    <img src="${imageUrl}" alt="${safeMasterName}" class="w-full h-64 object-cover">
                    <span class="absolute top-2 right-2 bg-orange text-white text-xs font-bold px-3 py-1 rounded-full">${p.price.toFixed(2)} €</span>
                </div>
                <div class="p-4">
                    <h3 class="font-semibold text-lg mb-1 truncate">${safeMasterName}</h3>
                    <p class="text-sm text-gray-500 mb-3 h-10 overflow-hidden">${safeDescription}</p>
                    <div class="flex flex-wrap gap-2 mb-4">
                        ${sizeButtons}
                    </div>
                </div>
            </div>
        `;
    }
    productContainer.innerHTML = html;
}


// Mise à Jour de la Fonction updateCartDisplays (CORRIGÉE: Utilise les bons IDs)
function updateCartDisplays() {
    // CORRECTION: Utilise les IDs du HTML
    const cartList = document.getElementById('cart-items-list');
    const cartListMobile = document.getElementById('cart-items-list-mobile');
    const emptyMsg = document.getElementById('empty-cart-message');
    const emptyMsgMobile = document.getElementById('empty-cart-message-mobile');
    const cartCount = document.getElementById('cart-count'); // ID Corrigé
    
    // Vider les listes
    cartList.innerHTML = '';
    cartListMobile.innerHTML = '';
    
    let subtotal = 0;
    let totalItems = 0;

    cart.forEach(item => {
        subtotal += item.price * item.quantity;
        totalItems += item.quantity;
        
        const productDiv = document.createElement('div');
        productDiv.className = 'flex justify-between items-center py-2 border-b';
        productDiv.innerHTML = `
            <div class="flex-1">
                <p class="font-medium">${item.name} (Taille ${item.size})</p>
                <p class="text-sm text-gray-500">${item.price.toFixed(2)} € x ${item.quantity}</p>
            </div>
            <div class="flex items-center space-x-2">
                <button onclick="changeQuantity('${item.id}', -1)" class="text-gray-500 hover:text-orange text-lg font-bold">-</button>
                <span class="font-semibold w-6 text-center">${item.quantity}</span>
                <button onclick="changeQuantity('${item.id}', 1)" class="text-gray-500 hover:text-orange text-lg font-bold">+</button>
                <button onclick="removeItem('${item.id}')" class="text-red-500 hover:text-red-700 ml-2 text-xl">x</button>
            </div>
        `;
        cartList.appendChild(productDiv.cloneNode(true));
        cartListMobile.appendChild(productDiv);
    });
    
    // Gérer les messages de panier vide
    if (emptyMsg) emptyMsg.style.display = totalItems === 0 ? 'block' : 'none';
    if (emptyMsgMobile) emptyMsgMobile.style.display = totalItems === 0 ? 'block' : 'none';
    
    // CORRECTION: Calcul du total avec les frais de port
    let shippingCost = selectedShipping ? selectedShipping.cost : 0;
    let totalFinal = subtotal + shippingCost;
    
    // Mettre à jour la bulle du panier
    if (cartCount) cartCount.textContent = totalItems;

    // Mettre à jour l'affichage du panier (Partie droite)
    document.getElementById('cart-subtotal').textContent = `${subtotal.toFixed(2)} €`;
    document.getElementById('cart-shipping').textContent = `${shippingCost.toFixed(2)} €`; 
    document.getElementById('cart-total').textContent = `${totalFinal.toFixed(2)} €`;
    
    // Mettre à jour l'affichage du panier (Partie mobile)
    document.getElementById('cart-subtotal-mobile').textContent = `${subtotal.toFixed(2)} €`;
    document.getElementById('cart-shipping-mobile').textContent = `${shippingCost.toFixed(2)} €`; 
    document.getElementById('cart-total-mobile').textContent = `${totalFinal.toFixed(2)} €`;
    
    // Mettre à jour les champs cachés du formulaire
    document.getElementById('total-final-client-input').value = totalFinal.toFixed(2);
    document.getElementById('nombre-articles-total').value = totalItems;
    
    // Mettre à jour l'affichage dans le formulaire (Partie droite)
    document.getElementById('form-total-text').textContent = `${totalFinal.toFixed(2)} €`;

    // Mettre à jour l'état du bouton PayPal
    handlePaymentMethodChange(); 
}

// Fonction auxiliaire pour le payload PayPal
function createPaypalOrderPayload(total) {
    return {
        intent: 'CAPTURE',
        purchase_units: [{
            amount: { currency_code: 'EUR', value: total.toFixed(2) },
            description: `Achat Kicks Boutique - Total: ${total.toFixed(2)} €`,
        }]
    };
}

// Fonctions auxiliaires pour le récapitulatif (Utilisées par le payload)
function buildRecapText(cart) {
    let text = "Récapitulatif des articles:\n";
    cart.forEach(item => {
        text += `- ${item.name} (Taille ${item.size}) x ${item.quantity} à ${item.price.toFixed(2)} €\n`;
    });
    return text;
}
function buildRecapHTML(cart) {
    let html = '<ul style="list-style:none; padding:0; margin:0;">';
    cart.forEach(item => {
        html += `<li style="margin-bottom: 5px;"><strong>${item.name}</strong> (Taille ${item.size}) x ${item.quantity} - ${item.price.toFixed(2)} €/u</li>`;
    });
    html += '</ul>';
    return html;
}

// Mise à Jour de la Fonction buildCreateOrderPayload (Cohérente avec le Apps Script)
function buildCreateOrderPayload(methodePaiement, sumupCheckoutId = null, paypalOrderId = null) {
    if(cart.length === 0) throw new Error("Panier vide");
    
    const zoneLivraison = document.getElementById('shipping-zone').value;
    const modeLivraison = document.getElementById('shipping-mode').value;
    
    if (!zoneLivraison || !modeLivraison || !selectedShipping) {
        alert("Veuillez sélectionner la Zone et le Mode de Livraison.");
        throw new Error("Missing shipping selection");
    }

    return {
        action: 'createOrder',
        recaptchaResponse: grecaptcha.getResponse(),
        methodePaiement: methodePaiement,
        sumupCheckoutId: sumupCheckoutId,
        paypalOrderId: paypalOrderId,
        
        modeLivraison: modeLivraison,
        zoneLivraison: zoneLivraison,

        prenom: document.getElementById('prenom').value,
        nom: document.getElementById('nom').value,
        email: document.getElementById('email').value,
        telephone: document.getElementById('telephone').value,
        adresse: document.getElementById('adresse').value,
        communeCP: document.getElementById('commune-cp').value,

        totalFinalClient: document.getElementById('total-final-client-input').value,
        nombreArticlesTotal: document.getElementById('nombre-articles-total').value,
        productsJson: JSON.stringify(cart),
        recapText: buildRecapText(cart),
        recapHTML: buildRecapHTML(cart),
        redirectUrl: window.location.href // URL de retour pour SumUp
    };
}

// Fonction de confirmation
function showConfirmationAndClear(prenom) {
    alert(`Merci ${prenom} ! Votre commande est enregistrée. Un email de confirmation a été envoyé.`);
    cart = [];
    selectedShipping = null; // Réinitialiser la livraison
    updateCartDisplays();
    document.getElementById('checkout-form').reset();
    document.getElementById('virement-info').classList.add('hidden');
    document.getElementById('form-paiement-modal').style.display='none';
    // Réinitialiser les options de livraison
    updateShippingOptions(shippingRates);
}

// Fonction de création de commande POST (POST unique)
async function postCreateOrder(payload) {
    if (!payload.prenom || !payload.nom || !payload.email || !payload.telephone || !payload.adresse || !payload.communeCP) {
        throw new Error('Veuillez compléter tous les champs client (Nom, Email, Adresse, Zone).');
    }
    
    // Le déstockage est géré par le Apps Script (handleUpdateStock)
    const data = await postData(payload);
    return data;
}

// Fonction SumUp (CORRIGÉE: Utilise le payload complet et le SDK)
async function handleSumUpCheckout() {
    if(cart.length===0) return alert('Votre panier est vide.');
    const token = grecaptcha.getResponse();
    if(!token) return alert('Veuillez compléter le reCAPTCHA.');

    try {
        const payload = buildCreateOrderPayload('SumUp'); // Vérification de livraison incluse ici
        
        // 1. Appel à Apps Script pour créer un checkout SumUp
        const data = await postData({
            action: 'createSumUpCheckout',
            ...payload // Envoyer toutes les infos
        });
        
        if (!data.success || !data.checkoutId) {
            alert('Erreur SumUp: ' + (data.error || 'Échec de la création du paiement.'));
            console.error('SumUp API Error:', data);
            return;
        }

        // 2. Initialisation SumUp SDK avec l'ID reçu
        const checkout = new window.SumupCard.Checkout({
            checkoutId: data.checkoutId,
            onResponse: async (type, body) => {
                if (type === 'success') {
                    // Le paiement est OK, mais on n'appelle PAS postCreateOrder ici
                    // Le Webhook s'en occupe côté serveur (déstockage, email)
                    showConfirmationAndClear(payload.prenom);
                } else if (type === 'error') {
                    alert('Erreur de paiement par carte: ' + body.message);
                    console.error('SumUp Error:', body);
                }
            }
        });

        checkout.open();

    } catch(e) {
        console.error('handleSumUpCheckout err', e);
        if(e.message !== "Missing shipping selection") alert('Veuillez remplir correctement le formulaire et votre panier.');
    }
}

// Gestion des méthodes de paiement et PayPal rendu
function handlePaymentMethodChange() {
    const totalFinal = parseFloat(document.getElementById('total-final-client-input').value);
    const paypalButtonContainer = document.getElementById('paypal-button-container');
    
    // Vider le conteneur PayPal pour le rerendu
    paypalButtonContainer.innerHTML = '';
    paypalButtonContainer.dataset.rendered = 'false';

    if (totalFinal > 0) {
      if(paypalButtonContainer.dataset.rendered !== 'true'){
        paypal.Buttons({
          style: { layout: 'horizontal', color: 'blue', shape: 'rect', label: 'paypal', tagline: false },
          createOrder: function(data, actions) {
            // Valider le formulaire AVANT d'ouvrir PayPal
            if (!document.getElementById('checkout-form').checkValidity()) {
                alert("Veuillez remplir tous les champs (Prénom, Nom, Email, Adresse...).");
                document.getElementById('checkout-form').reportValidity();
                return Promise.reject(new Error("Formulaire incomplet"));
            }
            if (!selectedShipping) {
                alert("Veuillez sélectionner un mode de livraison.");
                return Promise.reject(new Error("Livraison non sélectionnée"));
            }
            return actions.order.create(createPaypalOrderPayload(totalFinal));
          },
          onApprove: async function(data, actions) {
            const order = await actions.order.capture();
            const payload = buildCreateOrderPayload('paypal', null, order.id); 
            try{
                const orderData = await postCreateOrder(payload);
                if(orderData.success){ showConfirmationAndClear(payload.prenom); } else { alert('Erreur création commande (PayPal): ' + (orderData.error || 'Erreur')); console.error(orderData); }
            } catch(e){ console.error('createOrder (PayPal) err', e); alert('Erreur réseau.'); }
          },
          onError: function (err) { console.error('PayPal Checkout Error', err); alert('Une erreur est survenue lors du paiement PayPal.'); }
        }).render('#paypal-button-container');
        paypalButtonContainer.dataset.rendered = 'true';
      }
    }
}

// Fonctions modales (CORRIGÉES: Ciblent les bons IDs)
function openImageModal(productId, initialIndex) {
    const p = products.find(prod => prod.id === productId);
    if (!p || !p.imageUrls || p.imageUrls.length === 0) return;
    
    currentModal.product = p;
    currentModal.imgIndex = initialIndex;
    
    document.getElementById('modal-image').src = p.imageUrls[initialIndex];
    document.getElementById('img-modal').style.display = 'flex';
}
function nextImage() {
    if (!currentModal.product) return;
    currentModal.imgIndex = (currentModal.imgIndex + 1) % currentModal.product.imageUrls.length;
    document.getElementById('modal-image').src = currentModal.product.imageUrls[currentModal.imgIndex];
}
function prevImage() {
    if (!currentModal.product) return;
    currentModal.imgIndex = (currentModal.imgIndex - 1 + currentModal.product.imageUrls.length) % currentModal.product.imageUrls.length;
    document.getElementById('modal-image').src = currentModal.product.imageUrls[currentModal.imgIndex];
}

// Logique Newsletter
document.getElementById('newsletter-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('newsletter-email').value;
    const messageElement = document.getElementById('newsletter-message');
    
    // CORRECTION: Le payload doit correspondre au Apps Script
    const payload = { action: 'addNewsletter', email: email, recaptchaResponse: grecaptcha.getResponse() }; // Ajout reCAPTCHA si nécessaire

    try {
        const data = await postData(payload);
        messageElement.classList.remove('hidden', 'text-red-500');
        messageElement.classList.add('text-green-400');
        if (data.success) {
            messageElement.textContent = 'Merci pour votre inscription !';
            document.getElementById('newsletter-form').reset();
        } else {
            messageElement.classList.remove('text-green-400');
            messageElement.classList.add('text-red-500');
            messageElement.textContent = data.error || 'Erreur d\'inscription.';
        }
    } catch(error) {
        messageElement.classList.remove('hidden', 'text-green-400');
        messageElement.classList.add('text-red-500');
        messageElement.textContent = 'Erreur réseau. Veuillez réessayer.';
    }
    
    setTimeout(() => { messageElement.classList.add('hidden'); }, 5000);
});

// INITIALISATION DU SCRIPT
async function init() {
    await fetchProducts();
    await fetchShippingRates(); 
    updateCartDisplays(); // Met à jour le panier (qui est peut-être en localStorage)
}

// Écouteurs globaux (CORRIGÉS: Ciblent les bons IDs)
document.addEventListener('DOMContentLoaded', () => {
  init();

  // Écouteurs Modal Image
  document.getElementById('next-img-btn').addEventListener('click', nextImage);
  document.getElementById('prev-img-btn').addEventListener('click', prevImage);
  document.getElementById('close-img-modal-btn').addEventListener('click', () => { document.getElementById('img-modal').style.display = 'none'; });

  // Écouteurs Boutons Panier
  document.getElementById('btn-submit-quick').addEventListener('click', async (e)=>{
    if(cart.length===0) return alert('Votre panier est vide.');
    
    const form = document.getElementById('checkout-form');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    if (!selectedShipping) {
        alert("Veuillez sélectionner un mode de livraison.");
        return;
    }
    const token = grecaptcha.getResponse();
    if(!token) return alert('Veuillez compléter le reCAPTCHA.');
    
    try {
        const payload = buildCreateOrderPayload('virement', null);
        const data = await postCreateOrder(payload); // Utilise la fonction POST unique
        if(data.success){ showConfirmationAndClear(payload.prenom); } else { alert('Erreur création commande: ' + (data.error || 'Erreur')); console.error(data); }
    } catch(e){ 
        if(e.message !== "Missing shipping selection") console.error('createOrder err', e); 
        if(e.message !== "Missing shipping selection") alert('Erreur réseau / Panier vide.'); 
    }
  });
  
  // Bouton SumUp
  document.getElementById('sumup-btn').addEventListener('click', handleSumUpCheckout);

  // Bouton Virement
  document.getElementById('virement-button').addEventListener('click', ()=>{
    document.getElementById('virement-info').classList.toggle('hidden');
  });

  // Vider le panier (les deux boutons)
  document.getElementById('btn-clear-cart').addEventListener('click', ()=>{
    if(confirm('Vider le panier ?')){ cart=[]; selectedShipping = null; updateCartDisplays(); }
  });
  document.getElementById('btn-clear-cart-default').addEventListener('click', ()=>{
    if(confirm('Vider le panier ?')){ cart=[]; selectedShipping = null; updateCartDisplays(); }
  });

  // Bouton d'ouverture du panier (Mobile)
  document.getElementById('cart-button').addEventListener('click', () => {
      document.getElementById('form-paiement-modal').style.display = 'block';
  });
  // Bouton de fermeture du panier (Mobile)
  document.getElementById('close-checkout-button').addEventListener('click', () => {
      document.getElementById('form-paiement-modal').style.display = 'none';
  });

});
</script>
</body>
</html>
	
